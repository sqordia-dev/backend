services:
  sqordia-webapi:
    build:
      context: .
      dockerfile: src/WebAPI/Dockerfile
    container_name: sqordia-api-dev
    ports:
      - "5241:8080"  # Map host port 5241 to container port 8080
    environment:
      # Environment
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      
      # Database Connection - Using local PostgreSQL container
      # The service name 'sqordia-db' is used to connect to the PostgreSQL container
      - ConnectionStrings__DefaultConnection=Host=sqordia-db;Port=5432;Database=SqordiaDb;Username=sqordia;Password=SqordiaDevPass2025;Pooling=false;
      
      # JWT Settings
      - JwtSettings__Secret=${JWT_SECRET:-fZCrXaY7jlvsqKSLpJeRbdw6TDoFIA8yB4OziUgVWH95tmQE21xh3NGkPncMu0}
      - JwtSettings__Issuer=${JWT_ISSUER:-Sqordia}
      - JwtSettings__Audience=${JWT_AUDIENCE:-SqordiaUsers}
      - JwtSettings__ExpirationMinutes=${JWT_EXPIRATION_MINUTES:-60}
      
      # Google OAuth (optional - set via environment variables)
      # For local development, you can set these in your .env file or environment
      # Client ID: 787375969256-r1qbhjb39t2r77ro1evr849ph75s8i4n.apps.googleusercontent.com
      # NOTE: Explicitly set to override any system environment variables
      - GoogleOAuth__ClientId=787375969256-r1qbhjb39t2r77ro1evr849ph75s8i4n.apps.googleusercontent.com
      - GoogleOAuth__ClientSecret=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      
      # OpenAI Configuration
      # For local dev: Set OPENAI_API_KEY in your .env file or system environment
      # For production: Use Azure Container App environment variables
      # This file is safe for local development defaults (not committed to git)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OpenAI__ApiKey=${OPENAI_API_KEY:-}
      - OpenAI__Model=${OPENAI_MODEL:-gpt-4o}
      - AI__OpenAI__ApiKey=${OPENAI_API_KEY:-}
      - AI__OpenAI__Model=${OPENAI_MODEL:-gpt-4o}
      
      # Alternative AI Providers (optional)
      - AI__Claude__ApiKey=${CLAUDE_API_KEY:-}
      - AI__Gemini__ApiKey=${GEMINI_API_KEY:-}
      
      # Azure Communication Services Email Configuration (preferred)
      # Set AzureCommunicationServices__ConnectionString to use Azure Communication Services Email
      - AzureCommunicationServices__ConnectionString=${AZURE_COMMUNICATION_SERVICES_CONNECTION_STRING:-}
      - AzureCommunicationServices__FromEmail=${AZURE_COMMUNICATION_SERVICES_FROM_EMAIL:-sqordia.dev@gmail.com}
      - AzureCommunicationServices__FromName=${AZURE_COMMUNICATION_SERVICES_FROM_NAME:-Sqordia}
      
      # Alternative: SendGrid Configuration (using appsettings.Development.json via mounted volume)
      # Only set if environment variable is provided, otherwise use appsettings file
      - SendGrid__FromEmail=${SENDGRID_FROM_EMAIL:-sqordia.dev@gmail.com}
      - SendGrid__FromName=${SENDGRID_FROM_NAME:-Sqordia}
      
      # Azure Service Bus Configuration (fallback if Azure Communication Services is not configured)
      - AzureServiceBus__ConnectionString=${AZURE_SERVICE_BUS_CONNECTION_STRING:-}
      - AzureServiceBus__EmailTopic=${AZURE_SERVICE_BUS_EMAIL_TOPIC:-email-jobs}
      
      # AWS Storage (optional)
      - AwsStorage__BucketName=${S3_BUCKET_NAME:-sqordia-documents}
      - AwsStorage__Region=${AWS_REGION:-ca-central-1}
      
      # Disable HTTPS redirect for Docker development
      - DISABLE_HTTPS_REDIRECT=true
      
      # Frontend URL for CORS (development)
      - FRONTEND_BASE_URL=http://localhost:5173
      
      # Enable database seeding on startup (for local development)
      - Database__RunSeedsOnStartup=true
    volumes:
      # Mount logs directory if needed
      - ./logs:/app/logs
      # Mount seed script for easy updates during development
      - ./scripts/seed-all.sql:/app/scripts/seed-all.sql:ro
    networks:
      - sqordia-network
    depends_on:
      sqordia-db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Local PostgreSQL container for development
  sqordia-db:
    image: postgres:16-alpine
    container_name: sqordia-db-dev
    environment:
      - POSTGRES_USER=sqordia
      - POSTGRES_PASSWORD=SqordiaDevPass2025
      - POSTGRES_DB=SqordiaDb
      - POSTGRES_HOST_AUTH_METHOD=trust
    ports:
      - "5433:5432"  # Expose PostgreSQL port for external tools (pgAdmin, DBeaver, etc.)
    volumes:
      - sqordia-db-data:/var/lib/postgresql/data
    networks:
      - sqordia-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sqordia -d SqordiaDb"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 10s

networks:
  sqordia-network:
    driver: bridge

volumes:
  sqordia-db-data:
    driver: local
