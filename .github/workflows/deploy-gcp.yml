name: Deploy to GCP

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
        type: boolean

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'northamerica-northeast2' }}
  ARTIFACT_REGISTRY_REPO: sqordia-production-repo
  IMAGE_NAME: sqordia-api
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
  GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

jobs:
  build-and-deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Run tests (optional)
        if: ${{ !inputs.skip_tests }}
        run: |
          dotnet test --no-build --verbosity normal || echo "Tests failed but continuing deployment"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest

      - name: Push Docker image
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest

      - name: Build Cloud Functions
        run: |
          chmod +x scripts/build-cloud-functions.sh
          ./scripts/build-cloud-functions.sh ${{ env.GCP_PROJECT_ID }} ${{ env.GCP_REGION }} || echo "Cloud Functions build skipped"

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform Init
        working-directory: infrastructure/terraform/gcp
        run: |
          terraform init -upgrade

      - name: Prepare Terraform Resources
        env:
          TF_VAR_gcp_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_gcp_region: ${{ env.GCP_REGION }}
          TF_VAR_cloud_sql_password: ${{ secrets.CLOUD_SQL_PASSWORD }}
        run: |
          echo "=== Preparing resources for Terraform ==="
          echo "This will import existing resources or clean them up if safe"
          echo ""
          if [ -f "scripts/prepare-terraform-resources.sh" ]; then
            chmod +x scripts/prepare-terraform-resources.sh
            scripts/prepare-terraform-resources.sh ${{ env.GCP_PROJECT_ID }} ${{ env.GCP_REGION }} sqordia production
            echo "âœ… Preparation completed"
          else
            echo "âš ï¸  Preparation script not found, skipping step"
          fi
        continue-on-error: true

      - name: Terraform Plan
        working-directory: infrastructure/terraform/gcp
        env:
          TF_VAR_gcp_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_gcp_region: ${{ env.GCP_REGION }}
          TF_VAR_cloud_sql_password: ${{ secrets.CLOUD_SQL_PASSWORD }}
        run: |
          terraform plan -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        working-directory: infrastructure/terraform/gcp
        env:
          TF_VAR_gcp_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_gcp_region: ${{ env.GCP_REGION }}
          TF_VAR_cloud_sql_password: ${{ secrets.CLOUD_SQL_PASSWORD }}
        run: |
          terraform apply -auto-approve tfplan

      - name: Get Cloud Run URL
        id: cloud-run
        working-directory: infrastructure/terraform/gcp
        run: |
          URL=$(terraform output -raw cloud_run_service_url)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Cloud Run URL: $URL"

      - name: Health Check
        run: |
          sleep 30  # Wait for Cloud Run to be ready
          URL="${{ steps.cloud-run.outputs.url }}"
          if [ -n "$URL" ]; then
            curl -f "$URL/health" || echo "Health check failed"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cloud Run URL:** ${{ steps.cloud-run.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
